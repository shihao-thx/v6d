<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dask on Vineyard &mdash; vineyard  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/vineyard.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Machine Learning with Vineyard" href="ml.html" />
    <link rel="prev" title="Airflow on Vineyard" href="airflow.html" />

 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6CYXWKLJB8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6CYXWKLJB8');
</script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> vineyard
          </a>
              <div class="version">
                0.5.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="divein.html">Diving into vineyard</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/adding-custom-datatypes-cpp.html">Adding Custom Data Types in C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/distributed-learning.html">Distributed Learning with Vineyard</a></li>
</ul>
<p class="caption"><span class="caption-text">Third-party Integration</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="airflow.html">Airflow on Vineyard</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Dask on Vineyard</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-deployment">The Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preprocessing-in-dask">Preprocessing in Dask</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-in-tensorflow">Training in Tensorflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transfer-learning">Transfer Learning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ml.html">Machine Learning with Vineyard</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to vineyard</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ctl.html">Vineyard Cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp-api.html">C++ API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-api.html">Python API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">vineyard</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Dask on Vineyard</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notes/dask.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="dask-on-vineyard">
<h1>Dask on Vineyard<a class="headerlink" href="#dask-on-vineyard" title="Permalink to this headline"></a></h1>
<p>The integration with Dask allows dask.array and dask.dataframe to be persisted on and loaded from Vineyard.
In the following, we first demonstrate that, with Vineyard, it is much easier to implement the example that employs
dask for data preprocessing and tensorflow for distributed learning,
which was previously shown in the <a class="reference external" href="http://matthewrocklin.com/blog/work/2017/02/11/dask-tensorflow">blog</a>.</p>
<div class="section" id="the-deployment">
<h2>The Deployment<a class="headerlink" href="#the-deployment" title="Permalink to this headline"></a></h2>
<img alt="Dask Tensorflow Workflow" src="../_images/dask-tf.jpg" />
<p>As shown in the figure above, we only use two machines for the distributed tasks
as the purpose of demonstration.
The vineyard damon processes are launched on both machines, so as the dask workers.
The dask scheduler is launched in the first machine, and we also run the
dask preprocess program here in the first step, since the dask scheduler handles the distribution
of computation tasks among its workers.</p>
<p>Then in the second step, we will run the training program on both machines with different <strong>TF_CONFIG</strong>.
For the detail of how to set up the config, please refer to <a class="reference external" href="https://www.tensorflow.org/tutorials/distribute/multi_worker_with_keras">documentation</a>.</p>
</div>
<div class="section" id="preprocessing-in-dask">
<h2>Preprocessing in Dask<a class="headerlink" href="#preprocessing-in-dask" title="Permalink to this headline"></a></h2>
<p>In this step, we load the mnist data and duplicate it to simulate the parallel processing as same as the <a class="reference external" href="http://matthewrocklin.com/blog/work/2017/02/11/dask-tensorflow">blog</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">vineyard.core.builder</span> <span class="kn">import</span> <span class="n">builder_context</span>
<span class="kn">from</span> <span class="nn">vineyard.contrib.dask.dask</span> <span class="kn">import</span> <span class="n">register_dask_types</span>

<span class="k">def</span> <span class="nf">dask_preprocess</span><span class="p">(</span><span class="n">dask_scheduler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_mnist</span><span class="p">():</span>
        <span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="c1"># The `x` arrays are in uint8 and have values in the [0, 255] range.</span>
        <span class="c1"># You need to convert them to float64 with values in the [0, 1] range.</span>
        <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_train</span><span class="p">),</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y_train</span><span class="p">})</span>

    <span class="k">with</span> <span class="n">builder_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">builder</span><span class="p">:</span>
        <span class="c1"># register the builder for dask.dataframe to the builder_context</span>
        <span class="n">register_dask_builder</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">delayed</span><span class="p">(</span><span class="n">get_mnist</span><span class="p">)()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">from_delayed</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
        <span class="n">gdf_id</span> <span class="o">=</span> <span class="n">vineyard</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">dask_scheduler</span><span class="o">=</span><span class="n">dask_scheduler</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf_id</span>
</pre></div>
</div>
<p>Here the returned <strong>gdf_id</strong> is the ObjectID of a <strong>vineyard::GlobalDataFrame</strong>
which consists of 20 partitions (10 partitions on each machine).</p>
</div>
<div class="section" id="training-in-tensorflow">
<h2>Training in Tensorflow<a class="headerlink" href="#training-in-tensorflow" title="Permalink to this headline"></a></h2>
<p>In this step, we use the preprocessed data <strong>gdf_id</strong> to train a model distributedly
in keras of Tensorflow.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">vineyard.contrib.ml.tensorflow</span> <span class="kn">import</span> <span class="n">register_tf_types</span>
<span class="kn">from</span> <span class="nn">vineyard.core.resolver</span> <span class="kn">import</span> <span class="n">resolver_context</span>

<span class="k">def</span> <span class="nf">mnist_dataset</span><span class="p">(</span><span class="n">gdf_id</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">resolver_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">resolver</span><span class="p">:</span>
        <span class="c1"># register the resolver for tensorflow Dataset to the resolver_context</span>
        <span class="n">register_tf_types</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolver</span><span class="p">)</span>
        <span class="n">train_datasets</span> <span class="o">=</span> <span class="n">vineyard</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gdf_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="n">train_datasets</span> <span class="o">=</span> <span class="n">train_datasets</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
        <span class="n">options</span><span class="o">.</span><span class="n">experimental_distribute</span><span class="o">.</span><span class="n">auto_shard_policy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AutoShardPolicy</span><span class="o">.</span><span class="n">OFF</span>
        <span class="n">train_datasets_no_auto_shard</span> <span class="o">=</span> <span class="n">train_datasets</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">train_datasets_no_auto_shard</span>

<span class="k">def</span> <span class="nf">build_and_compile_cnn_model</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">(</span><span class="n">target_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">gdf_id</span><span class="p">):</span>
    <span class="n">per_worker_batch_size</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MultiWorkerMirroredStrategy</span><span class="p">()</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">mnist_dataset</span><span class="p">(</span><span class="n">gdf_id</span><span class="p">,</span> <span class="n">per_worker_batch_size</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="n">multi_worker_model</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">build_and_compile_cnn_model</span><span class="p">()</span>

    <span class="n">multi_worker_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
</pre></div>
</div>
<p>To use the preprocessed data, we register the resolvers that can resolve a <strong>vineyard::GlobalDataFrame</strong> distributedly
by mulitple workers to the resolver_context. Then we can get the <strong>tf.data.Dataset</strong> directly from vineyard by the <strong>get</strong>
method. Note that we should specify the column names for the data and label which were set in the last step.</p>
</div>
<div class="section" id="transfer-learning">
<h2>Transfer Learning<a class="headerlink" href="#transfer-learning" title="Permalink to this headline"></a></h2>
<p>After the simple example above, now we demonstrate how the dask-vineyard integration can be leveraged in transfer learning.
In a nutshell, transfer learning takes a pre-trained deep learning model to compute features for downstream models.
Moreover, it’s better to persist the features in memory, so that the fine-tuning of the downstream models
will neither recompute the features nor incur too much I/O costs to read the features from disk again and again.
In the following, we refer to the <a class="reference external" href="https://docs.databricks.com/_static/notebooks/deep-learning/deep-learning-transfer-learning-keras.html">featurization</a> example. We load the <a class="reference external" href="https://www.tensorflow.org/datasets/catalog/tf_flowers">tf_flowers</a> data as a <strong>dask.array</strong>;
then use the pre-trained <strong>ResNet50</strong> model to generate the features; and finally save them in Vineyard.
The global tensor in Vineyard will consists of 8 partitions, each with 400 data slots.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_images</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;flower_photos&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.jpg&quot;</span><span class="p">))[</span><span class="n">idx</span><span class="p">::</span><span class="n">num</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
          <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="o">.</span><span class="n">resize</span><span class="p">([</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">])</span>
          <span class="n">arr</span> <span class="o">=</span> <span class="n">preprocess_input</span><span class="p">(</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
          <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">featurize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">block_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ResNet50</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">preds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">100352</span><span class="p">)</span>

<span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">from_delayed</span><span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">get_images</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
<span class="n">imgs</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span><span class="n">featurize</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">100352</span><span class="p">),</span> <span class="n">drop_axis</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">global_tensor_id</span> <span class="o">=</span> <span class="n">vineyard</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dask_scheduler</span><span class="o">=</span><span class="n">dask_scheduler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
      <div class="rst-footer-buttons" role="navigation" aria-label="Footer">
          <a href="airflow.html" class="btn btn-neutral float-left" title="Airflow on Vineyard" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
          <a href="ml.html" class="btn btn-neutral float-right" title="Machine Learning with Vineyard" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      </div>
  
    <hr/>
  
    <div role="contentinfo">

      <p>
        Vineyard is a <a href="https://www.cncf.io/sandbox-projects/">CNCF sandbox project</a>.
      </p>
      <img src="https://v6d.io/_static/cncf-color.svg" alt="CLOUD NATIVE COMPUTING FOUNDATION" width="40%"/>
      <p>
        The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation,
        please see our <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage page</a>.
      </p>

      <hr/>&#169; Copyright 2019-2021, The Vineyard Contributors.

      <p></p>
    </div>
  
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
      <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>provided by <a href="https://readthedocs.org">Read the Docs</a>.
     
  
  </footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>